#!/bin/bash

OutFil=background.xml
Statc=595.0
Trns=5.0
FilTyp="gif|jpg|png|bmp"
SortFil=Alphabetic
# SortFil=Random
Dpth=30

ImgFils=$(
  find $PWD -maxdepth $Dpth -regextype posix-extended \
                      -iregex ".*\.($FilTyp)" 2> /dev/null )

if  [ "$SortFil" == "Random" ] ; then
  ImgFils=$( echo -e "$ImgFils" | sort -R )
elif  [ "$SortFil" == "Alphabetic" ] ; then
  ImgFils=$( echo -e "$ImgFils" | sort )
fi

filtol=$(echo -e "$ImgFils" | wc -l | cut -d " " -f1)

if [ $filtol -gt 1 ] ; then
  Yer=$(date +%Y)
  Mnth=$(date +%m)
  Day=$(date +%d)
  Head="  <static>\n    <duration>$Statc</duration>\n    <file>"
  Tail="</file>\n  </static>"
  FrmHead="  <transition>\n    <duration>$Trns</duration>\n    <from>"
  FrmTail="</from>"
  ToHead="    <to>"
  ToTail="</to>\n  </transition>"

  (
    echo "<background>"
    echo "  <starttime>"
    echo "    <year>$Yer</year>"
    echo "    <month>$Mnth</month>"
    echo "    <day>$Day</day>"
    echo "    <hour>00</hour>"
    echo "    <minute>00</minute>"
    echo "    <second>00</second>"
    echo "  </starttime>"
    echo "<!-- This animation starts at $Yer/$Mnth/$Day 00:00. -->"

    if [ "$Trns" == "0" ] ; then
      echo -e "$ImgFils" | sed "s|^\(.*\)$|$Head\0$Tail|"
    else
      FstFil=$( echo -e "$ImgFils" | head -n 1 )
      echo -e "${Head}${FstFil}${Tail}"
      echo -e "${FrmHead}${FstFil}${FrmTail}"
      echo -e "$ImgFils" | tail -n +2 \
       | sed "s|^\(.*\)$|$ToHead\0$ToTail\n$Head\0$Tail\n$FrmHead\0$FrmTail|"
      echo -e "${ToHead}${FstFil}${ToTail}"
    fi

    echo "</background>"
  ) > $OutFil

else
  /usr/bin/zenity --warning --title="Error!" \
     --text="Need two image files at least!"  > /dev/null 2>&1
  echo -e "\nError!\nNeed two image files at least!\n"
  exit 1
fi
